name: publish-pypi

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  wait-unit-tests:
    name: Wait for unit-tests workflow
    runs-on: ubuntu-latest
    permissions:
      actions: read
    steps:
      - name: Wait for unit-tests success
        env:
          GH_TOKEN: ${{ github.token }}
          TARGET_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          workflow_id=$(gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[] | select(.name=="unit-tests") | .id' | head -n 1)
          if [[ -z "${workflow_id:-}" ]]; then
            echo "Could not find unit-tests workflow id in repository workflows."
            exit 1
          fi

          echo "Waiting for unit-tests workflow (id: $workflow_id) to finish for SHA $TARGET_SHA"

          for attempt in {1..40}; do
            run_info=$(gh api "repos/${{ github.repository }}/actions/workflows/${workflow_id}/runs" \
              --jq 'first(.workflow_runs[] | select(.head_sha=="'"${TARGET_SHA}"'"))')

            if [[ -z "${run_info:-}" || "$run_info" == "null" ]]; then
              echo "No matching unit-tests run yet (attempt $attempt/40); sleeping 30s..."
              sleep 30
              continue
            fi

            status=$(echo "$run_info" | jq -r '.status')
            conclusion=$(echo "$run_info" | jq -r '.conclusion // ""')
            url=$(echo "$run_info" | jq -r '.html_url')

            echo "unit-tests workflow run: $url (status=$status, conclusion=$conclusion)"

            if [[ "$status" == "completed" ]]; then
              if [[ "$conclusion" == "success" ]]; then
                echo "unit-tests workflow completed successfully."
                exit 0
              else
                echo "unit-tests workflow finished with conclusion=$conclusion"
                exit 1
              fi
            fi

            sleep 30
          done

          echo "Timed out waiting for unit-tests workflow to complete."
          exit 1

  build-and-publish:
    runs-on: ubuntu-latest
    needs: wait-unit-tests
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # setuptools-scm needs the tags

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build deps
        run: |
          python -m pip install -U pip
          pip install build twine

      - name: Extract version from tag
        id: version
        run: |
          echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          echo "Publishing PG-SUI version ${GITHUB_REF_NAME#v}"

      - name: Build
        run: |
          rm -rf dist/
          python -m build

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          twine upload --non-interactive --skip-existing --repository testpypi dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload --non-interactive --skip-existing dist/*

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Automated release for PG-SUI ${{ github.ref_name }}.
