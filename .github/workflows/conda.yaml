name: conda

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

jobs:
  tests:
    name: Unit tests (pip)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean test artifacts
        run: rm -rf dist build .pytest_cache tmp_test_output

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        env:
          MPLCONFIGDIR: ${{ runner.temp }}/mpl
        run: |
          python -m pip install -U pip
          python -m pip install ".[dev]"

      - name: Run tests
        env:
          MPLCONFIGDIR: ${{ runner.temp }}/mpl
        run: pytest -q

  clean:
    name: Clean conda build cache
    runs-on: ubuntu-latest
    steps:
      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: conda-clean
          create-args: >-
            micromamba
          init-shell: bash

      - name: Clean conda build cache
        run: |
          micromamba clean --all --yes

  conda-package:
    name: Build conda package
    runs-on: ubuntu-latest
    needs: [tests, clean]
    if: startsWith(github.ref, 'refs/tags/v')
    defaults:
      run:
        shell: bash -l {0}
    env:
      MPLCONFIGDIR: /tmp/mpl
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: conda-build
          create-args: >-
            python=3.11
            pip
            conda-build
            anaconda-client
            -c conda-forge
            -c defaults
          init-shell: bash
          cache-environment: true

      - name: Build recipe
        env:
          PKG_VERSION: ${{ github.ref_name }}
        run: |
          export PKG_VERSION=${PKG_VERSION#v}
          conda build conda/recipe --output-folder conda/dist -c btmartin721 -c conda-forge -c defaults

      - name: Upload conda artifacts
        uses: actions/upload-artifact@v4
        with:
          name: conda-packages
          path: conda/dist/**/*.tar.bz2

      - name: Publish to Anaconda
        env:
          ANACONDA_API_TOKEN: ${{ secrets.CONDA_UPLOAD_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${ANACONDA_API_TOKEN:-}" ]]; then
            echo "CONDA_UPLOAD_TOKEN not set; skipping upload."
            exit 0
          fi
          files=$(find conda/dist -type f \( -name '*.tar.bz2' -o -name '*.conda' \))
          anaconda -t "$ANACONDA_API_TOKEN" upload --label main --user btmartin721 $files
